# This is a basic GitHub Actions workflow for running CI tests on a Django
# project. It runs on Ubuntu 22.04 with 4 parallel jobs, caches system
# packages and Python dependencies, and checks out the repository with a
# fetch depth of 1. The build job sets the Python version to 3.11 and runs
# the tests using the specified matrix. It is triggered on push or pull
# request events on the main branch, as well as manually using the
# workflow_dispatch event. For more information, see
# https://docs.github.com/en/actions/guides/building-and-testing-python#building-and-testing-python-with-multiple-versions
name: Django CI (basic)
on:
  push:
    paths:
      - 'apps/api/**'
      - '.github/workflows/django.yml'
  pull_request:
    paths:
      - 'apps/api/**'
  workflow_dispatch:

jobs:

  build:
    runs-on: ubuntu-22.04
    container: python:3.11

    # Service containers to run with `build` job
    services:
      # Label used to access the service container
      postgres:
        # Docker Hub image
        image: postgres:16.2-bookworm
        # Provide the password for postgres
        env:
          POSTGRES_PASSWORD: bronco
        # Set health checks to wait until postgres has started
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          # Maps tcp port 5432 on service container to the host
          - 5432:5432

    env:
      DB_NAME: postgres
      DB_USER: postgres
      DB_HOST: postgres
      DB_PASSWORD: bronco
      DB_PORT: 5432
      DB_ENGINE: django.db.backends.postgresql

    defaults:
      run:
        working-directory: ./apps/api
    strategy:
      max-parallel: 4
      matrix:
        python-version: ["3.11"]

    steps:
    - uses: actions/checkout@v4
      with:
        fetch-depth: 1
        submodules: true

    - name: Set up Python ${{ matrix.python-version }}
      uses: actions/setup-python@v4.7.0
      with:
        python-version: ${{ matrix.python-version }}

    - name: Install Pillow
      run: python -m pip install Pillow

    - name: Install Dependencies
      run: |
        python -m pip install --upgrade pip
        python -m pip install -r requirements.txt
        python -m pip install Django==4.2.11

    # - name: Cache system packages
    #   uses: actions/cache@v3.3.2
    #   with:
    #     path: /var/cache/apt/archives
    #     key: ${{ runner.os }}-apt-${{ hashFiles('apt.txt') }}
    #     restore-keys: ${{ runner.os }}-apt-

    # - name: Cache python dependencies
    #   uses: actions/cache@v3.3.2
    #   with:
    #     path: ~/.cache/pip
    #     key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
    #     restore-keys: |
    #       ${{ runner.os }}-pip-

    - name: Run migrations
      run: |
        python manage.py migrate

    - name: Run Tests
      run: |
        python manage.py collectstatic --noinput

    - name: Run Tests
      run: |
        python manage.py test afbcore.tests
